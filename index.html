<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projet Minutieux - Visionneuse README</title>
    <!-- Tailwind CSS pour un design robuste et rapide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuration Tailwind pour activer le Dark Mode via une classe
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Marked.js pour parser le Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Three.js pour la visualisation 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Styles de base pour le contenu Markdown rendu (Clair & Sombre) */
        .markdown-body { transition: color 0.3s; }
        .markdown-body h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.25em; }
        .markdown-body h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-body a { color: #2563eb; text-decoration: underline; }
        .markdown-body ul { list-style-type: disc; padding-left: 2em; margin-bottom: 1em; }
        .markdown-body code { background-color: #f3f4f6; padding: 0.2em 0.4em; border-radius: 0.25em; font-family: monospace; }
        .markdown-body pre { background-color: #1f2937; color: #f3f4f6; padding: 1em; border-radius: 0.5em; overflow-x: auto; margin-bottom: 1em; }
        
        /* Ajustements Dark Mode pour le Markdown */
        .dark .markdown-body { color: #d1d5db; }
        .dark .markdown-body h1 { border-bottom-color: #374151; color: #f3f4f6; }
        .dark .markdown-body h2 { color: #e5e7eb; }
        .dark .markdown-body a { color: #60a5fa; }
        .dark .markdown-body code { background-color: #374151; color: #e5e7eb; }

        #canvas-container canvas { border-radius: 0.5rem; width: 100% !important; height: auto !important; aspect-ratio: 1 / 1; outline: none; }
        
        /* Transition douce pour le changement de th√®me */
        body { transition: background-color 0.3s, color 0.3s; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-gray-800 dark:text-gray-200 font-sans min-h-screen">

    <!-- En-t√™te -->
    <header class="bg-slate-800 dark:bg-slate-950 text-white p-4 shadow-md border-b-4 border-slate-700">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-bold tracking-tight">üõ†Ô∏è Monsieur Minutieux</h1>
                <span class="hidden sm:inline-block text-xs bg-slate-700 px-3 py-1 rounded-full border border-slate-600">DIY & Design Robuste</span>
            </div>
            
            <!-- Piton Dark Mode -->
            <button id="theme-toggle" class="bg-slate-700 hover:bg-slate-600 border border-slate-500 text-xl p-2 rounded-full transition-colors focus:outline-none" aria-label="Basculer le th√®me">
                üåô
            </button>
        </div>
    </header>

    <!-- Contenu Principal -->
    <main class="max-w-7xl mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8">
        
        <!-- Colonne Gauche : Le README rendu -->
        <section class="flex-1 bg-white dark:bg-slate-800 p-6 md:p-8 rounded-xl shadow-lg border-t-4 border-blue-600 transition-colors">
            <div class="flex justify-between items-center mb-6 border-b dark:border-slate-700 pb-4">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200">Documentation du Projet</h2>
                <div class="flex items-center gap-3">
                    <span id="offline-badge" class="hidden text-xs bg-yellow-100 text-yellow-800 border border-yellow-300 px-2 py-1 rounded shadow">‚ö° Mode Garage (Cache)</span>
                    <a href="https://tmcdo.github.io/README.md" target="_blank" class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        Source brute
                    </a>
                </div>
            </div>
            
            <div id="readme-content" class="markdown-body">
                <div class="flex items-center justify-center p-12 text-gray-500 dark:text-gray-400">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Chargement du README depuis le d√©p√¥t...
                </div>
            </div>
        </section>

        <!-- Colonne Droite : Outils Minutieux (3D & DB) -->
        <aside class="w-full lg:w-96 flex flex-col gap-8">
            
            <!-- Widget 3D -->
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg border-t-4 border-slate-800 dark:border-slate-500 transition-colors">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-2">Assemblage 3D (Composants)</h3>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Aper√ßu interactif : Boulon et √©crou. (Glisse la souris pour tourner)</p>
                <div id="canvas-container" class="bg-gray-50 dark:bg-slate-700 rounded-lg overflow-hidden cursor-move border border-gray-200 dark:border-slate-600 transition-colors"></div>
            </div>

            <!-- Base de donn√©es exportable -->
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-lg border-t-4 border-green-600 transition-colors">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200">Inventaire Mat√©riaux</h3>
                    <button id="export-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 rounded shadow transition-colors">
                        ‚Üì Exporter CSV
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-50 dark:bg-slate-700 transition-colors">
                            <tr>
                                <th class="px-3 py-2">Objet</th>
                                <th class="px-3 py-2">Mat√©riau</th>
                                <th class="px-3 py-2">Co√ªt</th>
                            </tr>
                        </thead>
                        <tbody id="db-table-body">
                            <!-- Rempli par JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </aside>
    </main>

    <footer class="bg-slate-800 dark:bg-slate-950 text-slate-400 text-center p-6 mt-8 transition-colors">
        <p class="text-sm">¬© 2026 Monsieur Minutieux - Design robuste, fabrication "low-cost" et sur-mesure.</p>
    </footer>

    <!-- Scripts de l'application -->
    <script>
        // --- 0. GESTION DU MODE SOMBRE ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;
        
        // V√©rifie la pr√©f√©rence syst√®me ou le choix sauvegard√©
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
            themeToggleBtn.innerText = '‚òÄÔ∏è';
        } else {
            htmlElement.classList.remove('dark');
            themeToggleBtn.innerText = 'üåô';
        }

        themeToggleBtn.addEventListener('click', () => {
            htmlElement.classList.toggle('dark');
            if (htmlElement.classList.contains('dark')) {
                localStorage.theme = 'dark';
                themeToggleBtn.innerText = '‚òÄÔ∏è';
            } else {
                localStorage.theme = 'light';
                themeToggleBtn.innerText = 'üåô';
            }
        });

        // --- 1. CHARGEMENT DU README.MD AVEC CACHE ---
        const urlToFetch = 'https://tmcdo.github.io/README.md';
        const readmeContainer = document.getElementById('readme-content');
        const offlineBadge = document.getElementById('offline-badge');
        const CACHE_KEY = 'mrminutieux_readme_cache';

        // Fonction pour afficher le markdown
        const renderMarkdown = (text) => {
            if(text.trim().toLowerCase().startsWith('<!doctype html>')) {
                readmeContainer.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 border-l-4 border-yellow-500">Oups! L'URL a retourn√© une page web au lieu d'un fichier Markdown brut. Assure-toi que le fichier existe bien √† cette adresse.</div>`;
            } else {
                readmeContainer.innerHTML = marked.parse(text);
            }
        };

        // On v√©rifie d'abord s'il y a quelque chose dans le cache pour affichage instantan√©
        const cachedReadme = localStorage.getItem(CACHE_KEY);
        if(cachedReadme) {
            renderMarkdown(cachedReadme);
            offlineBadge.classList.remove('hidden'); // On assume cache au d√©but
        }

        // On fetch la nouvelle version
        fetch(urlToFetch)
            .then(response => {
                if (!response.ok) throw new Error(`Erreur r√©seau: ${response.status}`);
                return response.text();
            })
            .then(markdownText => {
                // Succ√®s ! On met √† jour l'affichage et le cache
                renderMarkdown(markdownText);
                localStorage.setItem(CACHE_KEY, markdownText);
                offlineBadge.classList.add('hidden'); // On est live
            })
            .catch(error => {
                console.warn('Impossible de charger la nouvelle version, utilisation du cache si disponible.', error);
                if(!cachedReadme) {
                    readmeContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-800 border-l-4 border-red-500 font-bold">Ayoye! Impossible de charger le fichier et rien en m√©moire. Connecte-toi √† Internet pour le premier chargement. Erreur: ${error.message}</div>`;
                }
                // Si on a le cache, il est d√©j√† affich√©, on laisse le badge "Mode Garage"
            });

        // --- 2. BASE DE DONN√âES EXPORTABLE (DIY & Mat√©riaux) ---
        const materialsDB = [
            { id: 'M01', objet: 'Corni√®re 1.5"', materiau: 'Acier Galvanis√©', cout: '$', usage: 'Ch√¢ssis' },
            { id: 'M02', objet: 'Boulon Hex 3/8', materiau: 'Acier Grade 5', cout: '$', usage: 'Assemblage' },
            { id: 'M03', objet: 'Contreplaqu√© 3/4', materiau: 'Bois (√ârable)', cout: '$$', usage: 'Surfaces' },
            { id: 'M04', objet: 'Tube Carr√© 1"', materiau: 'Aluminium 6061', cout: '$$', usage: 'Structure l√©g√®re' },
            { id: 'M05', objet: '√âcrou Frein', materiau: 'Acier & Nylon', cout: '$', usage: 'Anti-vibration' },
            { id: 'M06', objet: 'Vis auto-perceuse', materiau: 'Acier Zingu√©', cout: '$', usage: 'Fixation m√©tal' },
            { id: 'M07', objet: 'Plaque 1/4"', materiau: 'Acier Doux', cout: '$$$', usage: 'Ancrage' }
        ];

        // Remplir la table
        const tbody = document.getElementById('db-table-body');
        materialsDB.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = "bg-white dark:bg-slate-800 border-b dark:border-slate-700 transition-colors";
            tr.innerHTML = `
                <td class="px-3 py-2 font-medium text-gray-900 dark:text-gray-100">${item.objet}</td>
                <td class="px-3 py-2">${item.materiau}</td>
                <td class="px-3 py-2 font-bold text-green-600 dark:text-green-400">${item.cout}</td>
            `;
            tbody.appendChild(tr);
        });

        // Fonction d'exportation CSV
        document.getElementById('export-btn').addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,ID,Objet,Mat√©riau,Co√ªt,Usage\n";
            materialsDB.forEach(row => {
                csvContent += `${row.id},"${row.objet}","${row.materiau}",${row.cout},"${row.usage}"\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "mrminutieux_materiaux.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- 3. VISUALISATION 3D (THREE.JS) ---
        window.onload = function () {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = width; // Carr√©
            
            const scene = new THREE.Scene();
            // Fond transparent pour s'adapter au Dark/Light mode
            scene.background = null; 

            const camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
            camera.position.z = 5;
            camera.position.y = 2;
            camera.lookAt(0, 0, 0);

            // Alpha: true permet la transparence
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setClearColor( 0x000000, 0 ); // Transparent
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            // Cr√©ation de l'assemblage
            const assemblyGroup = new THREE.Group();

            const metalMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x9ca3af, // Gris m√©tallique
                roughness: 0.3,
                metalness: 0.8
            });

            // 1. T√™te hexagonale du boulon
            const headGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.5, 6);
            const head = new THREE.Mesh(headGeometry, metalMaterial);
            head.position.y = 1;
            assemblyGroup.add(head);

            // 2. Tige du boulon
            const shaftGeometry = new THREE.CylinderGeometry(0.4, 0.4, 2.5, 16);
            const shaft = new THREE.Mesh(shaftGeometry, metalMaterial);
            shaft.position.y = -0.5;
            assemblyGroup.add(shaft);

            // 3. √âcrou (Hexagone avec un trou au milieu simul√© en empilant)
            // Pour faire low-cost sans calculs complexes (CSG), on fait un cylindre hex un peu plus large
            const nutGeometry = new THREE.CylinderGeometry(0.9, 0.9, 0.4, 6);
            const nutMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xcbd5e1, // Un peu plus clair pour le contraste
                roughness: 0.4,
                metalness: 0.7
            });
            const nut = new THREE.Mesh(nutGeometry, nutMaterial);
            nut.position.y = -1.2; // Viss√© sur la tige
            // Rotation l√©g√®re pour pas √™tre align√© parfaitement avec la t√™te (plus r√©aliste)
            nut.rotation.y = Math.PI / 12; 
            assemblyGroup.add(nut);

            scene.add(assemblyGroup);

            // Lumi√®res pour un effet m√©tallique
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 2);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0xbfdbfe, 1, 10); // Lueur bleut√©e
            pointLight.position.set(-2, 0, 2);
            scene.add(pointLight);

            // Interaction souris pour tourner l'assemblage
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            container.addEventListener('mousedown', () => isDragging = true);
            container.addEventListener('mouseup', () => isDragging = false);
            container.addEventListener('mouseleave', () => isDragging = false);
            
            // Support tactile
            container.addEventListener('touchstart', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }, {passive: true});
            container.addEventListener('touchend', () => isDragging = false);

            const handleMove = (clientX, clientY) => {
                if (isDragging) {
                    const deltaMove = {
                        x: clientX - previousMousePosition.x,
                        y: clientY - previousMousePosition.y
                    };
                    assemblyGroup.rotation.y += deltaMove.x * 0.01;
                    assemblyGroup.rotation.x += deltaMove.y * 0.01;
                }
                previousMousePosition = { x: clientX, y: clientY };
            };

            container.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));
            container.addEventListener('touchmove', (e) => {
                if(isDragging) handleMove(e.touches[0].clientX, e.touches[0].clientY);
            }, {passive: true});

            // Boucle d'animation
            function animate() {
                requestAnimationFrame(animate);
                if(!isDragging){
                    assemblyGroup.rotation.y += 0.005; // Rotation lente automatique
                }
                renderer.render(scene, camera);
            }

            // G√©rer le redimensionnement
            window.addEventListener('resize', () => {
                const newWidth = container.clientWidth;
                renderer.setSize(newWidth, newWidth);
                camera.aspect = 1;
                camera.updateProjectionMatrix();
            });

            animate();
        };
    </script>
</body>
</html>
