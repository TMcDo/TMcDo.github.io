<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. Minutieux - Planificateur 3D & Inventaire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Ajout de l'Import Map pour r√©soudre l'erreur de sp√©cificateur de module -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.150.1/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #111827; color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #canvas-container { outline: none; }
        /* Custom Scrollbar for robust industrial look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #f59e0b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d97706; }
        /* Emp√™cher le scroll sur mobile quand on gosse dans le 3D */
        canvas { touch-action: none; cursor: grab; }
        canvas:active { cursor: grabbing; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-full">

    <!-- 3D Visualization Area -->
    <div id="canvas-container" class="w-full md:w-2/3 h-[55vh] md:h-full relative touch-none">
        <div class="absolute top-4 left-4 z-10 bg-gray-900 bg-opacity-75 p-3 rounded-lg border border-gray-700 shadow-lg pointer-events-none">
            <h1 class="text-xl font-bold text-yellow-500 uppercase tracking-wider"><i class="fa-solid fa-hammer mr-2"></i>Mr. Minutieux</h1>
            <p class="text-xs text-gray-400">Atelier de conception 3D (Robuste & Low-Cost)</p>
            <p id="snap-status-text" class="text-[10px] text-amber-500 mt-1"><i class="fa-solid fa-magnet"></i> Magn√©tisation activ√©e</p>
        </div>
        
        <!-- Controls Overlay on 3D canvas -->
        <div class="absolute bottom-4 left-4 z-10 flex space-x-2">
            <button id="btn-toggle-snap" class="bg-amber-600 hover:bg-amber-500 text-white p-2 rounded border border-amber-700 shadow transition-colors" title="Activer/D√©sactiver la magn√©tisation">
                <i class="fa-solid fa-magnet"></i>
            </button>
            <button id="btn-reset-cam" class="bg-gray-800 hover:bg-gray-700 text-white p-2 rounded border border-gray-600 shadow transition-colors" title="R√©initialiser la cam√©ra">
                <i class="fa-solid fa-video"></i>
            </button>
            <button id="btn-clear" class="bg-red-900 hover:bg-red-800 text-white p-2 rounded border border-red-700 shadow transition-colors" title="Vider la sc√®ne">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>

        <!-- Panneau de contr√¥le d'objet s√©lectionn√© (Cach√© par d√©faut) -->
        <div id="object-controls" class="hidden absolute top-4 right-4 z-10 bg-gray-800 bg-opacity-95 p-3 rounded-lg border border-gray-600 shadow-xl flex-col space-y-2 pointer-events-auto w-48">
            <h3 class="text-xs text-gray-400 uppercase tracking-wider font-bold mb-1 border-b border-gray-600 pb-1 flex justify-between">
                Ajustements
                <span id="obj-dimensions" class="text-amber-400 font-mono text-[9px]"></span>
            </h3>
            
            <div class="flex items-center space-x-2 mb-1">
                <input type="color" id="obj-color-picker" class="w-8 h-8 rounded cursor-pointer bg-gray-700 border border-gray-500 p-0" title="Changer la couleur">
                <button id="btn-duplicate" class="bg-purple-600 hover:bg-purple-500 text-white py-1.5 px-2 rounded shadow text-xs font-bold transition-colors flex-1 flex items-center justify-center" title="Cloner la pi√®ce"><i class="fa-solid fa-copy mr-1"></i> Copier</button>
            </div>

            <div class="flex space-x-2">
                <button id="btn-up" class="bg-blue-600 hover:bg-blue-500 text-white py-2 px-3 rounded shadow text-xs font-bold transition-colors w-full" title="Monter"><i class="fa-solid fa-arrow-up"></i></button>
                <button id="btn-down" class="bg-blue-600 hover:bg-blue-500 text-white py-2 px-3 rounded shadow text-xs font-bold transition-colors w-full" title="Descendre"><i class="fa-solid fa-arrow-down"></i></button>
            </div>
            <div class="flex space-x-2">
                <button id="btn-rot-y" class="bg-green-600 hover:bg-green-500 text-white py-2 px-3 rounded shadow text-xs font-bold w-full transition-colors" title="Tourner sur le plancher"><i class="fa-solid fa-rotate-right mr-1"></i> 90¬∞</button>
                <button id="btn-rot-x" class="bg-emerald-700 hover:bg-emerald-600 text-white py-2 px-3 rounded shadow text-xs font-bold w-full transition-colors" title="Basculer"><i class="fa-solid fa-rotate mr-1"></i> Flip</button>
            </div>
            <button id="btn-del-obj" class="bg-red-700 hover:bg-red-600 text-white py-2 px-3 rounded shadow text-xs font-bold w-full mt-1 transition-colors"><i class="fa-solid fa-trash mr-1"></i> Supprimer</button>
        </div>
    </div>

    <!-- UI & Database Area -->
    <div id="ui-container" class="w-full md:w-1/3 h-[45vh] md:h-full bg-gray-800 border-t md:border-t-0 md:border-l border-gray-700 flex flex-col shadow-2xl z-20">
        
        <!-- Toolbar -->
        <div class="p-4 border-b border-gray-700 bg-gray-850">
            <h2 class="text-lg font-bold mb-3 text-gray-200">Ajouter des mat√©riaux</h2>
            <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                <button id="add-wood" class="bg-amber-700 hover:bg-amber-600 text-white py-2 px-3 rounded shadow font-medium text-sm transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-tree mr-2"></i> 2x4 (Bois)
                </button>
                <button id="add-mdf" class="bg-amber-900 hover:bg-amber-800 text-white py-2 px-3 rounded shadow font-medium text-sm transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-table-cells-large mr-2"></i> MDF
                </button>
                <button id="add-angle" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-3 rounded shadow font-medium text-sm transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-angle-right mr-2"></i> Corni√®re
                </button>
                <button id="add-tube" class="bg-slate-600 hover:bg-slate-500 text-white py-2 px-3 rounded shadow font-medium text-sm transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-ruler-vertical mr-2"></i> Tube
                </button>
                <button id="add-acrylic" class="bg-cyan-700 hover:bg-cyan-600 text-white py-2 px-3 rounded shadow font-medium text-sm transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-border-all mr-2"></i> Acrylique
                </button>
                <button id="add-screw" class="bg-zinc-500 hover:bg-zinc-400 text-white py-2 px-3 rounded shadow font-medium text-sm transition-transform active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-screwdriver mr-2"></i> Vis/Boulon
                </button>
            </div>
        </div>

        <!-- Database / Inventory Table -->
        <div class="flex-1 overflow-y-auto p-4 bg-gray-900">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-200">Inventaire du projet</h2>
                <span id="total-cost" class="text-yellow-500 font-bold bg-gray-800 px-2 py-1 rounded">0.00 $</span>
            </div>
            
            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-800">
                        <tr>
                            <th scope="col" class="px-3 py-2">Qt√©</th>
                            <th scope="col" class="px-3 py-2">Pi√®ce</th>
                            <th scope="col" class="px-3 py-2">Co√ªt/u</th>
                            <th scope="col" class="px-3 py-2 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list">
                        <!-- Items will be injected here via JS -->
                        <tr id="empty-state" class="bg-gray-800 border-b border-gray-700">
                            <td colspan="4" class="px-3 py-4 text-center text-gray-500 italic">Aucune pi√®ce dans la sc√®ne. Ajoutes-en une!</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Action -->
        <div class="p-4 border-t border-gray-700 bg-gray-800">
            <button id="btn-export" class="w-full bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded shadow-lg transition-colors flex justify-center items-center">
                <i class="fa-solid fa-file-csv mr-2"></i> Exporter la base de donn√©es (CSV)
            </button>
            <p class="text-xs text-center text-gray-500 mt-2">Pr√™t pour la shop! üõ†Ô∏è</p>
        </div>
    </div>

    <!-- ES Module Import for Three.js utilisant l'import map -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- STATE & DATABASE ---
        let inventory = {};
        let objectIdCounter = 0;
        const prices = {
            '2x4 (Bois)': 4.50,
            'Panneau MDF': 22.00,
            'Corni√®re (M√©tal)': 12.00,
            'Tube (M√©tal)': 15.50,
            'Feuille Acrylique': 35.00,
            'Vis/Boulon': 0.25
        };

        // --- THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1f2937); // Tailwind gray-800
        scene.fog = new THREE.Fog(0x1f2937, 20, 100);

        // Camera
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(10, 15, 20);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2 - 0.05; // Don't go below ground

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);

        // Ground & Grid
        const gridHelper = new THREE.GridHelper(40, 40, 0xf59e0b, 0x4b5563);
        gridHelper.position.y = -0.01;
        scene.add(gridHelper);

        const planeGeometry = new THREE.PlaneGeometry(40, 40);
        const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x111827, depthWrite: false });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        // Objects Array to manage ThreeJS meshes
        const sceneObjects = [];
        let visualBoxHelper = null; // La bo√Æte de mesure jaune

        // --- DRAG & DROP LOGIC (Magn√©tisation Sym√©trique & Hauteur) ---
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();
        const dragPlane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0); // Plan invisible pour glisser
        let activeObject = null; // L'objet actuellement s√©lectionn√©
        let isDragging = false;
        let dragOffset = new THREE.Vector3();
        const SNAP_SIZE = 0.5; // La force de la grille (0.5 = demi unit√©)
        let isSnapEnabled = true; // √âtat de la magn√©tisation
        
        const uiObjectControls = document.getElementById('object-controls');

        // Math pour la magn√©tisation
        function snapToGrid(value) {
            if (!isSnapEnabled) return value;
            return Math.round(value / SNAP_SIZE) * SNAP_SIZE;
        }

        function updateMeasurements() {
            if (!activeObject) return;
            
            // Mise √† jour de la bo√Æte visuelle jaune
            if (!visualBoxHelper) {
                visualBoxHelper = new THREE.BoxHelper(activeObject, 0xffff00);
                scene.add(visualBoxHelper);
            } else {
                visualBoxHelper.setFromObject(activeObject);
                visualBoxHelper.visible = true;
            }

            // Calcul des dimensions (En assumant 1 unit√© = 1 pouce pour le DIY)
            const box = new THREE.Box3().setFromObject(activeObject);
            const size = new THREE.Vector3();
            box.getSize(size);
            document.getElementById('obj-dimensions').innerText = `${size.x.toFixed(1)}"x${size.y.toFixed(1)}"x${size.z.toFixed(1)}"`;
        }

        renderer.domElement.addEventListener('pointerdown', (event) => {
            // Emp√™che de d√©clencher la s√©lection 3D si on clique sur l'interface
            if(event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT' || event.target.closest('button') || event.target.closest('input')) return;

            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(sceneObjects);

            if (intersects.length > 0) {
                controls.enabled = false; // Arr√™te de tourner la cam√©ra
                
                // Si on avait d√©j√† un objet de s√©lectionn√©, on lui enl√®ve son "glow"
                if(activeObject && activeObject !== intersects[0].object) {
                    activeObject.material.emissive.setHex(0x000000);
                }

                activeObject = intersects[0].object;
                isDragging = true;
                
                // Feedback visuel: l'objet allume un peu quand tu le pogne
                activeObject.material.emissive.setHex(0x333333);
                
                // Affiche les contr√¥les
                uiObjectControls.classList.remove('hidden');
                uiObjectControls.classList.add('flex');
                
                // Met √† jour la couleur dans le color picker
                document.getElementById('obj-color-picker').value = '#' + activeObject.material.color.getHexString();
                
                // Affiche les mesures
                updateMeasurements();

                // Calcule l'endroit exact o√π on a cliqu√© sur le plan
                dragPlane.setFromNormalAndCoplanarPoint(new THREE.Vector3(0, 1, 0), activeObject.position);
                const planeIntersect = new THREE.Vector3();
                raycaster.ray.intersectPlane(dragPlane, planeIntersect);
                dragOffset.copy(planeIntersect).sub(activeObject.position);
            } else {
                // Clic dans l'vide: on d√©s√©lectionne
                if(activeObject) {
                    activeObject.material.emissive.setHex(0x000000);
                }
                activeObject = null;
                if (visualBoxHelper) visualBoxHelper.visible = false;
                uiObjectControls.classList.add('hidden');
                uiObjectControls.classList.remove('flex');
            }
        });

        renderer.domElement.addEventListener('pointermove', (event) => {
            if (!isDragging || !activeObject) return;

            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(pointer, camera);
            const planeIntersect = new THREE.Vector3();
            
            if (raycaster.ray.intersectPlane(dragPlane, planeIntersect)) {
                const targetPosition = planeIntersect.sub(dragOffset);
                
                // Applique la magn√©tisation sym√©trique sur les axes X et Z
                activeObject.position.x = snapToGrid(targetPosition.x);
                activeObject.position.z = snapToGrid(targetPosition.z);
                
                // On garde le Y intact ici, on g√®re la hauteur avec les pitons!
                if (visualBoxHelper) visualBoxHelper.update();
            }
        });

        renderer.domElement.addEventListener('pointerup', () => {
            isDragging = false;
            controls.enabled = true; // Remet la cam√©ra active
            // Note: On garde `activeObject` s√©lectionn√© pour continuer d'utiliser les pitons
        });

        renderer.domElement.addEventListener('pointercancel', () => {
            isDragging = false;
            controls.enabled = true;
        });

        // --- FUNCTIONS ---

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function handleResize() {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        window.addEventListener('resize', handleResize);

        function addItem(type, exactPosition = null, exactRotation = null, exactColor = null) {
            let geometry, material, mesh;
            const yPosOffset = sceneObjects.length * 1.5; // Stack them loosely

            if (type === '2x4 (Bois)') {
                geometry = new THREE.BoxGeometry(0.5, 1, 8);
                material = new THREE.MeshStandardMaterial({ color: exactColor || 0x8B5A2B, roughness: 0.9 });
            } else if (type === 'Panneau MDF') {
                geometry = new THREE.BoxGeometry(8, 0.2, 8);
                material = new THREE.MeshStandardMaterial({ color: exactColor || 0xC29B62, roughness: 1.0 });
            } else if (type === 'Corni√®re (M√©tal)') {
                geometry = new THREE.BoxGeometry(0.2, 0.2, 6);
                material = new THREE.MeshStandardMaterial({ color: exactColor || 0x808080, metalness: 0.8, roughness: 0.4 });
            } else if (type === 'Tube (M√©tal)') {
                geometry = new THREE.CylinderGeometry(0.3, 0.3, 6, 16);
                material = new THREE.MeshStandardMaterial({ color: exactColor || 0xA9A9A9, metalness: 0.9, roughness: 0.2 });
                geometry.rotateZ(Math.PI / 2);
            } else if (type === 'Feuille Acrylique') {
                geometry = new THREE.BoxGeometry(6, 0.1, 6);
                material = new THREE.MeshPhysicalMaterial({ color: exactColor || 0xE0FFFF, metalness: 0.1, roughness: 0.1, transmission: 0.9, transparent: true, opacity: 0.7 });
            } else if (type === 'Vis/Boulon') {
                geometry = new THREE.CylinderGeometry(0.1, 0.1, 0.5, 8);
                material = new THREE.MeshStandardMaterial({ color: exactColor || 0xC0C0C0, metalness: 1, roughness: 0.1 });
            }

            // On s'assure que le mat√©riel supporte l'emissive pour le drag & drop
            material.emissive = new THREE.Color(0x000000);

            mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            
            if (exactPosition) {
                mesh.position.copy(exactPosition);
            } else {
                // Pop l'objet au centre avec magn√©tisation initiale
                const rawX = (Math.random() - 0.5) * 4;
                const rawZ = (Math.random() - 0.5) * 4;
                mesh.position.set(
                    snapToGrid(rawX), 
                    (type === 'Vis/Boulon' ? 0.25 : 0.5) + yPosOffset, 
                    snapToGrid(rawZ)
                );
            }

            if (exactRotation) {
                mesh.rotation.copy(exactRotation);
            } else {
                mesh.rotation.y = 0; 
            }

            mesh.userData = { id: ++objectIdCounter, type: type };
            scene.add(mesh);
            sceneObjects.push(mesh);

            // Update Database
            if (!inventory[type]) {
                inventory[type] = { count: 0, cost: prices[type] };
            }
            inventory[type].count++;
            
            updateUI();
            
            // Small animation pop
            mesh.scale.set(0.1, 0.1, 0.1);
            let s = 0.1;
            const popInterval = setInterval(() => {
                s += 0.2;
                if(s >= 1) {
                    mesh.scale.set(1,1,1);
                    clearInterval(popInterval);
                } else {
                    mesh.scale.set(s,s,s);
                }
            }, 16);
        }

        function removeOneItemType(type) {
            if (inventory[type] && inventory[type].count > 0) {
                // Find and remove from scene
                for (let i = sceneObjects.length - 1; i >= 0; i--) {
                    if (sceneObjects[i].userData.type === type) {
                        const obj = sceneObjects[i];
                        scene.remove(obj);
                        obj.geometry.dispose();
                        obj.material.dispose();
                        sceneObjects.splice(i, 1);
                        break; // Remove only one
                    }
                }
                
                // Update DB
                inventory[type].count--;
                if (inventory[type].count === 0) {
                    delete inventory[type];
                }
                updateUI();
            }
        }

        function clearScene() {
            sceneObjects.forEach(obj => {
                scene.remove(obj);
                obj.geometry.dispose();
                obj.material.dispose();
            });
            sceneObjects.length = 0;
            inventory = {};
            
            // Cacher le panneau de contr√¥le si la sc√®ne est vid√©e
            if(activeObject) {
                activeObject = null;
                uiObjectControls.classList.add('hidden');
                uiObjectControls.classList.remove('flex');
            }
            if(visualBoxHelper) visualBoxHelper.visible = false;
            
            updateUI();
        }

        function updateUI() {
            const tbody = document.getElementById('inventory-list');
            const totalCostEl = document.getElementById('total-cost');
            tbody.innerHTML = '';
            
            let total = 0;
            let hasItems = false;

            for (const [type, data] of Object.entries(inventory)) {
                if (data.count > 0) {
                    hasItems = true;
                    const itemTotal = data.count * data.cost;
                    total += itemTotal;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700';
                    tr.innerHTML = `
                        <td class="px-3 py-2 font-medium text-white">${data.count}</td>
                        <td class="px-3 py-2">${type}</td>
                        <td class="px-3 py-2">${data.cost.toFixed(2)} $</td>
                        <td class="px-3 py-2 text-right">
                            <button class="text-red-500 hover:text-red-400 p-1 delete-btn" data-type="${type}" title="Enlever 1">
                                <i class="fa-solid fa-minus-circle"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            }

            if (!hasItems) {
                tbody.innerHTML = `
                    <tr id="empty-state" class="bg-gray-800 border-b border-gray-700">
                        <td colspan="4" class="px-3 py-4 text-center text-gray-500 italic">Aucune pi√®ce dans la sc√®ne. Ajoutes-en une!</td>
                    </tr>
                `;
            }

            totalCostEl.innerText = `${total.toFixed(2)} $`;

            // Re-bind delete events
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = e.currentTarget.getAttribute('data-type');
                    removeOneItemType(type);
                });
            });
        }

        function exportToCSV() {
            if (Object.keys(inventory).length === 0) {
                alert("L'inventaire est vide! Ajoute des pi√®ces d'abord.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for UTF-8 BOM (Excel formatting)
            csvContent += "Quantite,Type de Piece,Cout Unitaire ($),Cout Total ($)\r\n";
            
            let grandTotal = 0;
            for (const [type, data] of Object.entries(inventory)) {
                const totalItem = data.count * data.cost;
                grandTotal += totalItem;
                // Escape quotes just in case
                const safeType = `"${type}"`;
                csvContent += `${data.count},${safeType},${data.cost.toFixed(2)},${totalItem.toFixed(2)}\r\n`;
            }
            csvContent += `\r\n,,,Total General:,${grandTotal.toFixed(2)}\r\n`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "mrminutieux_inventaire.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('add-wood').addEventListener('click', () => addItem('2x4 (Bois)'));
        document.getElementById('add-mdf').addEventListener('click', () => addItem('Panneau MDF'));
        document.getElementById('add-angle').addEventListener('click', () => addItem('Corni√®re (M√©tal)'));
        document.getElementById('add-tube').addEventListener('click', () => addItem('Tube (M√©tal)'));
        document.getElementById('add-acrylic').addEventListener('click', () => addItem('Feuille Acrylique'));
        document.getElementById('add-screw').addEventListener('click', () => addItem('Vis/Boulon'));
        
        document.getElementById('btn-clear').addEventListener('click', clearScene);
        document.getElementById('btn-reset-cam').addEventListener('click', () => {
            camera.position.set(10, 15, 20);
            controls.target.set(0, 0, 0);
        });
        
        // Logique du piton de magn√©tisation
        document.getElementById('btn-toggle-snap').addEventListener('click', () => {
            isSnapEnabled = !isSnapEnabled;
            const btn = document.getElementById('btn-toggle-snap');
            const statusText = document.getElementById('snap-status-text');
            
            if (isSnapEnabled) {
                btn.className = "bg-amber-600 hover:bg-amber-500 text-white p-2 rounded border border-amber-700 shadow transition-colors";
                statusText.className = "text-[10px] text-amber-500 mt-1";
                statusText.innerHTML = '<i class="fa-solid fa-magnet"></i> Magn√©tisation activ√©e';
            } else {
                btn.className = "bg-gray-800 hover:bg-gray-700 text-white p-2 rounded border border-gray-600 shadow transition-colors";
                statusText.className = "text-[10px] text-gray-500 mt-1";
                statusText.innerHTML = '<i class="fa-solid fa-magnet"></i> Magn√©tisation d√©sactiv√©e';
            }
        });
        
        // --- LOGIQUE DU PANNEAU DE CONTR√îLE (HAUTEUR & ROTATION) ---
        
        // Couleur
        document.getElementById('obj-color-picker').addEventListener('input', (e) => {
            if(activeObject) activeObject.material.color.set(e.target.value);
        });

        // Dupliquer
        document.getElementById('btn-duplicate').addEventListener('click', () => {
            if(activeObject) {
                const type = activeObject.userData.type;
                // Offset de 1 unit√© pour pas cloner direct par dessus
                const newPos = activeObject.position.clone().add(new THREE.Vector3(1, 0.5, 1)); 
                addItem(type, newPos, activeObject.rotation, activeObject.material.color.getHex());
            }
        });

        document.getElementById('btn-up').addEventListener('click', () => {
            if(activeObject) {
                activeObject.position.y += isSnapEnabled ? SNAP_SIZE : 0.1;
                updateMeasurements();
            }
        });
        document.getElementById('btn-down').addEventListener('click', () => {
            if(activeObject && activeObject.position.y > 0) {
                activeObject.position.y -= isSnapEnabled ? SNAP_SIZE : 0.1;
                if(activeObject.position.y < 0) activeObject.position.y = 0; // Pas dans l'plancher!
                updateMeasurements();
            }
        });
        document.getElementById('btn-rot-y').addEventListener('click', () => {
            if(activeObject) {
                activeObject.rotation.y += Math.PI / 2; // Flip de 90 degr√©s
                updateMeasurements();
            }
        });
        document.getElementById('btn-rot-x').addEventListener('click', () => {
            if(activeObject) {
                activeObject.rotation.x += Math.PI / 2; // Flip de l'autre bord
                updateMeasurements();
            }
        });
        document.getElementById('btn-del-obj').addEventListener('click', () => {
            if(activeObject) {
                const type = activeObject.userData.type;
                scene.remove(activeObject);
                activeObject.geometry.dispose();
                activeObject.material.dispose();
                
                const index = sceneObjects.indexOf(activeObject);
                if(index > -1) sceneObjects.splice(index, 1);
                
                if (inventory[type] && inventory[type].count > 0) {
                    inventory[type].count--;
                    if (inventory[type].count === 0) delete inventory[type];
                }
                updateUI();
                
                activeObject = null;
                if(visualBoxHelper) visualBoxHelper.visible = false;
                uiObjectControls.classList.add('hidden');
                uiObjectControls.classList.remove('flex');
            }
        });

        document.getElementById('btn-export').addEventListener('click', exportToCSV);

        // Start App
        animate();

    </script>
</body>
</html>
