<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonie des Chakras</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js for 3D visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Tone.js for audio generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        #three-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* On desktop, the list has its own scrollbar */
        @media (min-width: 768px) {
            .frequency-list::-webkit-scrollbar { width: 4px; }
            .frequency-list::-webkit-scrollbar-track { background: #1f2937; }
            .frequency-list::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 20px; }
        }
        
        .freq-button.active {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--chakra-glow-color), 0 0 10px var(--chakra-shadow-color);
            border-color: var(--chakra-shadow-color);
            background-color: #374151; /* bg-gray-700 */
        }
        /* Custom toggle switch style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5; /* indigo-600 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="flex flex-col md:flex-row md:h-screen w-full">

        <!-- Left Panel: 3D Visualization and Controls -->
        <!-- On mobile, it has a fixed height. On desktop, it takes the full screen height. -->
        <div class="relative w-full md:w-2/3 h-64 sm:h-80 md:h-full bg-black">
            <div id="three-container" class="absolute inset-0"></div>
            <div id="info-overlay" class="absolute top-4 left-4 p-4 bg-black bg-opacity-50 rounded-lg backdrop-blur-sm transition-opacity duration-500 opacity-0">
                <h2 id="chakra-name" class="text-2xl font-bold"></h2>
                <p id="chakra-sanskrit" class="text-lg text-gray-300"></p>
                <div id="chakra-frequency-display" class="font-mono mt-2 text-lg"></div>
            </div>
        </div>

        <!-- Right Panel: Chakra Selection -->
        <!-- On desktop, this panel has a fixed height and an internal scrollbar for the list -->
        <div class="w-full md:w-1/3 flex flex-col bg-gray-900 p-4 sm:p-6 md:h-full">
            <header class="text-center mb-4 flex-shrink-0">
                <h1 class="text-2xl sm:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-600">Harmonie des Chakras</h1>
                <p class="text-gray-400 text-sm sm:text-base">Sélectionnez une fréquence pour commencer</p>
            </header>

            <!-- Controls section -->
            <div class="flex-shrink-0">
                <!-- Master Controls -->
                <div class="flex items-center justify-center space-x-4 mb-4">
                    <button id="play-pause-button" class="p-4 bg-indigo-600 rounded-full shadow-lg hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500 transition-transform transform hover:scale-110 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                    <div class="w-full max-w-xs flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5.071 8.036A1 1 0 016 7h1a1 1 0 011 1v4a1 1 0 01-1 1H6a1 1 0 01-1-1v-1.586l-.293.293a1 1 0 01-1.414-1.414l2-2zM12 7a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1h-1a1 1 0 01-1-1V7z" /></svg>
                        <input id="volume-slider" type="range" min="-40" max="0" value="-10" step="1" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                
                <!-- Audio Options / Mixer -->
                <div id="audio-options" class="space-y-3 p-4 bg-gray-800 rounded-lg mb-4">
                    <h3 class="text-center font-semibold text-gray-300">Options Audio Supplémentaires</h3>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Battements Binauraux</span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="binaural-toggle" id="binaural-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="binaural-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400">Pulsions Isochrones</span>
                         <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="isochronic-toggle" id="isochronic-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="isochronic-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Frequency List -->
            <!-- On mobile, this list expands. On desktop, it scrolls internally. -->
            <div id="frequency-list-container" class="flex-grow md:overflow-y-auto frequency-list md:pr-2">
                <!-- Buttons will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const chakraData = [
                { id: 'root', name: 'Racine', sanskrit: 'Muladhara', color: 0xf87171, shadow: '#E53E3E', frequencies: [228, 456, 912] },
                { id: 'sacral', name: 'Sacré', sanskrit: 'Svadhisthana', color: 0xfb923c, shadow: '#F56565', frequencies: [303, 606, 1212] },
                { id: 'solar-plexus', name: 'Plexus Solaire', sanskrit: 'Manipura', color: 0xf6e05e, shadow: '#F6B728', frequencies: [182, 364, 728] },
                { id: 'heart', name: 'Cœur', sanskrit: 'Anahata', color: 0x68d391, shadow: '#48BB78', frequencies: [128, 256, 512] },
                { id: 'throat', name: 'Gorge', sanskrit: 'Vishuddha', color: 0x63b3ed, shadow: '#4299E1', frequencies: [192, 384, 768] },
                { id: 'third-eye', name: 'Troisième Œil', sanskrit: 'Ajna', color: 0x667eea, shadow: '#5A67D8', frequencies: [144, 288, 576] },
                { id: 'crown', name: 'Couronne', sanskrit: 'Sahasrara', color: 0x9f7aea, shadow: '#805AD5', frequencies: [216, 432, 864] }
            ];

            const solfeggioData = [
                { name: 'Ut', frequency: 396, color: 0xf87171, shadow: '#E53E3E' },
                { name: 'Re', frequency: 417, color: 0xfb923c, shadow: '#F56565' },
                { name: 'Mi', frequency: 528, color: 0xf6e05e, shadow: '#F6B728' },
                { name: 'Fa', frequency: 639, color: 0x68d391, shadow: '#48BB78' },
                { name: 'Sol', frequency: 741, color: 0x63b3ed, shadow: '#4299E1' },
                { name: 'La', frequency: 852, color: 0x667eea, shadow: '#5A67D8' },
                { name: 'Si', frequency: 963, color: 0x9f7aea, shadow: '#805AD5' }
            ];

            // --- DOM ELEMENTS ---
            const frequencyListContainer = document.getElementById('frequency-list-container');
            const playPauseButton = document.getElementById('play-pause-button');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const volumeSlider = document.getElementById('volume-slider');
            const threeContainer = document.getElementById('three-container');
            const infoOverlay = document.getElementById('info-overlay');
            const chakraNameEl = document.getElementById('chakra-name');
            const chakraSanskritEl = document.getElementById('chakra-sanskrit');
            const chakraFrequencyEl = document.getElementById('chakra-frequency-display');
            const binauralToggle = document.getElementById('binaural-toggle');
            const isochronicToggle = document.getElementById('isochronic-toggle');

            // --- STATE ---
            let isPlaying = false;
            let currentSelection = null;
            let audioInitialized = false;
            let isBinauralEnabled = false;
            let isIsochronicEnabled = false;

            // --- AUDIO (Tone.js) ---
            let solfeggioOsc, binauralLeft, binauralRight, isochronicPulse;
            let pannerLeft, pannerRight;
            const masterVolume = new Tone.Volume(-10).toDestination();

            function initializeAudio() {
                if (audioInitialized) return;
                solfeggioOsc = new Tone.Oscillator({ type: 'sine', volume: -3 }).connect(masterVolume);
                pannerLeft = new Tone.Panner(-1).connect(masterVolume);
                pannerRight = new Tone.Panner(1).connect(masterVolume);
                binauralLeft = new Tone.Oscillator({ type: 'sine', volume: -12 }).connect(pannerLeft);
                binauralRight = new Tone.Oscillator({ type: 'sine', volume: -12 }).connect(pannerRight);
                const isochronicEnv = new Tone.AmplitudeEnvelope({ attack: 0.01, decay: 0.1, sustain: 1.0, release: 0.1 }).connect(masterVolume);
                isochronicPulse = new Tone.PulseOscillator('4hz', 0.5).connect(isochronicEnv);
                Tone.getTransport().scheduleRepeat(time => {
                    if (currentSelection && isPlaying && isIsochronicEnabled) {
                        isochronicEnv.triggerAttackRelease('16n', time);
                    }
                }, '8n');
                audioInitialized = true;
            }

            // --- 3D VISUALIZATION (Three.js) ---
            let scene, camera, renderer, sphere, particles;
            const clock = new THREE.Clock();
            function initThree() {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, threeContainer.clientWidth / threeContainer.clientHeight, 0.1, 1000);
                camera.position.z = 5;
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                threeContainer.appendChild(renderer.domElement);
                const geometry = new THREE.IcosahedronGeometry(1, 6);
                const material = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0x000000, roughness: 0.3, metalness: 0.1, transparent: true, opacity: 0.8 });
                sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);
                const particleCount = 2000;
                const particleGeometry = new THREE.BufferGeometry();
                const positions = new Float32Array(particleCount * 3);
                for (let i = 0; i < particleCount * 3; i++) { positions[i] = (Math.random() - 0.5) * 10; }
                particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                const particleMaterial = new THREE.PointsMaterial({ size: 0.02, color: 0xffffff, transparent: true, opacity: 0.5 });
                particles = new THREE.Points(particleGeometry, particleMaterial);
                scene.add(particles);
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 1);
                pointLight.position.set(5, 5, 5);
                scene.add(pointLight);
                animate();
            }
            function animate() {
                requestAnimationFrame(animate);
                const elapsedTime = clock.getElapsedTime();
                sphere.rotation.y += 0.001;
                sphere.rotation.x += 0.0005;
                if (isPlaying && currentSelection) {
                    const pulse = Math.sin(elapsedTime * (currentSelection.freq / 100)) * 0.1 + 1;
                    sphere.scale.set(pulse, pulse, pulse);
                } else {
                    sphere.scale.lerp(new THREE.Vector3(1, 1, 1), 0.1);
                }
                particles.rotation.y += 0.0005;
                renderer.render(scene, camera);
            }
            window.addEventListener('resize', () => {
                camera.aspect = threeContainer.clientWidth / threeContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
            });

            // --- UI LOGIC ---
            function createFrequencyLists() {
                const chakraTitle = document.createElement('h3');
                chakraTitle.className = 'text-lg font-bold text-gray-400 mt-4 mb-2';
                chakraTitle.textContent = 'Fréquences des Chakras';
                frequencyListContainer.appendChild(chakraTitle);
                chakraData.forEach(chakra => {
                    const group = document.createElement('div');
                    group.className = 'mb-3';
                    const name = document.createElement('p');
                    name.className = 'font-semibold text-base mb-1';
                    name.textContent = chakra.name;
                    name.style.color = new THREE.Color(chakra.color).getStyle();
                    group.appendChild(name);
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'grid grid-cols-3 gap-2';
                    chakra.frequencies.forEach(freq => {
                        const button = createFreqButton({ freq, color: chakra.color, shadow: chakra.shadow, name: chakra.name, sanskrit: chakra.sanskrit });
                        buttonContainer.appendChild(button);
                    });
                    group.appendChild(buttonContainer);
                    frequencyListContainer.appendChild(group);
                });

                const solfeggioTitle = document.createElement('h3');
                solfeggioTitle.className = 'text-lg font-bold text-gray-400 mt-6 mb-2';
                solfeggioTitle.textContent = 'Fréquences de Guérison (Solfège)';
                frequencyListContainer.appendChild(solfeggioTitle);
                const solfeggioContainer = document.createElement('div');
                solfeggioContainer.className = 'grid grid-cols-3 gap-2';
                solfeggioData.forEach(item => {
                    const button = createFreqButton({ freq: item.frequency, color: item.color, shadow: item.shadow, name: `Solfeggio ${item.name}`, sanskrit: `${item.frequency} Hz` });
                    solfeggioContainer.appendChild(button);
                });
                frequencyListContainer.appendChild(solfeggioContainer);
            }

            function createFreqButton(selection) {
                const button = document.createElement('button');
                button.className = 'freq-button w-full p-2 bg-gray-800 rounded-lg shadow-md transition-all duration-300 ease-in-out border-2 border-transparent hover:bg-gray-700 focus:outline-none';
                button.textContent = `${selection.freq} Hz`;
                button.dataset.freq = selection.freq;
                button.style.setProperty('--chakra-glow-color', new THREE.Color(selection.color).getStyle());
                button.style.setProperty('--chakra-shadow-color', selection.shadow);
                button.addEventListener('click', () => selectFrequency(selection, button));
                return button;
            }

            function selectFrequency(selection, clickedButton) {
                const isAlreadyActive = clickedButton.classList.contains('active');

                if (isAlreadyActive) {
                    pause();
                    currentSelection = null;
                    clickedButton.classList.remove('active');
                    infoOverlay.style.opacity = '0';
                } 
                else {
                    if (isPlaying) {
                        pause();
                    }
                    currentSelection = selection;

                    document.querySelectorAll('.freq-button').forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    
                    sphere.material.color.set(selection.color);
                    sphere.material.emissive.set(selection.color);
                    sphere.material.emissiveIntensity = 0.4;
                    particles.material.color.set(selection.color);
                    
                    chakraNameEl.textContent = selection.name;
                    chakraSanskritEl.textContent = selection.sanskrit;
                    chakraFrequencyEl.innerHTML = `<span>Fréquence: ${selection.freq} Hz</span>`;
                    infoOverlay.style.opacity = '1';

                    play();
                }
            }
            
            function updateFrequencies(freq) {
                if (!audioInitialized) return;
                const binauralBeat = 4;
                const pulseRate = 4;
                solfeggioOsc.frequency.rampTo(freq, 0.1);
                binauralLeft.frequency.rampTo(freq - binauralBeat / 2, 0.1);
                binauralRight.frequency.rampTo(freq + binauralBeat / 2, 0.1);
                isochronicPulse.frequency.value = freq; 
                Tone.getTransport().bpm.rampTo(pulseRate * 30, 0.1);
            }

            function play() {
                if (!currentSelection) return;
                if (Tone.context.state !== 'running') { Tone.start(); }
                if (!audioInitialized) {
                    initializeAudio();
                }
                updateFrequencies(currentSelection.freq);
                
                solfeggioOsc.start();
                if (isBinauralEnabled) { binauralLeft.start(); binauralRight.start(); }
                if (isIsochronicEnabled) { isochronicPulse.start(); Tone.getTransport().start(); }

                isPlaying = true;
                playPauseButton.disabled = false;
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }

            function pause() {
                if (audioInitialized) {
                    solfeggioOsc.stop();
                    binauralLeft.stop();
                    binauralRight.stop();
                    isochronicPulse.stop();
                    Tone.getTransport().stop();
                }
                isPlaying = false;
                playPauseButton.disabled = true;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }

            // --- EVENT LISTENERS ---
            playPauseButton.addEventListener('click', () => {
                if (isPlaying) {
                    const activeButton = document.querySelector('.freq-button.active');
                    if (activeButton) {
                        selectFrequency(currentSelection, activeButton);
                    }
                }
            });
            volumeSlider.addEventListener('input', (e) => { masterVolume.volume.value = e.target.value; });

            binauralToggle.addEventListener('change', (e) => {
                isBinauralEnabled = e.target.checked;
                if (isPlaying) {
                    if (isBinauralEnabled) { binauralLeft.start(); binauralRight.start(); } 
                    else { binauralLeft.stop(); binauralRight.stop(); }
                }
            });

            isochronicToggle.addEventListener('change', (e) => {
                isIsochronicEnabled = e.target.checked;
                if (isPlaying) {
                    if (isIsochronicEnabled) { isochronicPulse.start(); Tone.getTransport().start(); } 
                    else { isochronicPulse.stop(); Tone.getTransport().stop(); }
                }
            });

            // --- INITIALIZATION ---
            createFrequencyLists();
            initThree();
        });
    </script>

</body>
</html>
