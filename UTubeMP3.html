<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M. Minutieux - Extracteur 100% Gratuit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(71, 85, 105, 0.5); }
        #canvas-container { cursor: grab; }
        #canvas-container:active { cursor: grabbing; }
        .progress-bar-stripes {
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 1rem 1rem;
            animation: move-stripes 1s linear infinite;
        }
        @keyframes move-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4 sm:px-8">

    <!-- Header -->
    <header class="w-full max-w-6xl mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <i class="ph-fill ph-wrench text-4xl text-orange-500"></i>
            <div>
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold tracking-tight uppercase text-orange-500">M. Minutieux</h1>
                    <span class="bg-green-600 text-white text-[10px] font-bold px-2 py-0.5 rounded ml-3 uppercase tracking-wider shadow-md border border-green-400">100% Gratuit</span>
                </div>
                <p class="text-sm text-gray-400 font-mono">Extracteur DIY v2.6 // Bypass Lien Direct</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="shareBtn" class="text-sm bg-blue-900/40 hover:bg-blue-800/60 text-blue-300 px-4 py-2 rounded-md border border-blue-700/50 transition shadow-lg flex items-center gap-2">
                <i class="ph-bold ph-share-network"></i> <span id="lblShare">Partager</span>
            </button>
            <button id="langToggle" class="text-sm bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md border border-gray-600 transition shadow-lg">
                EN / FR
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="w-full max-w-6xl flex flex-col lg:flex-row gap-8">
        
        <!-- Left Panel: Controls -->
        <div class="glass-panel w-full lg:w-1/2 p-6 rounded-2xl flex flex-col gap-6 shadow-2xl relative border-t-4 border-t-green-500">
            <div>
                <label id="lblUrl" class="block text-sm font-medium text-gray-300 mb-2">Lien de la vidéo (URL)</label>
                <div class="flex items-center bg-gray-900 border border-gray-600 rounded-lg overflow-hidden focus-within:border-orange-500 transition">
                    <i class="ph ph-youtube-logo text-gray-400 ml-3 text-xl"></i>
                    <input type="text" id="urlInput" placeholder="https://www.youtube.com/watch?v=..." class="w-full bg-transparent border-none p-3 text-white focus:outline-none focus:ring-0">
                </div>
                <!-- Zone d'affichage du titre dynamique -->
                <div id="videoTitleDisplay" class="text-sm mt-2 font-mono h-5 truncate max-w-full text-gray-400"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label id="lblFormat" class="block text-sm font-medium text-gray-300 mb-2">Format (Gratuit)</label>
                    <select id="formatSelect" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:border-orange-500">
                        <option value="mp3">Audio MP3 (Standard Free)</option>
                        <option value="wav">Audio WAV (Uncompressed)</option>
                        <option value="opus">Audio OPUS (Open-Source)</option>
                        <option value="mp4">Vidéo MP4 (Max Free Res)</option>
                    </select>
                </div>
                <div>
                    <label id="lblQuality" class="block text-sm font-medium text-gray-300 mb-2">Moteur (Réseau)</label>
                    <select class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:border-orange-500 cursor-not-allowed" disabled>
                        <option value="cobalt">Cobalt + Bypass Invidious (0$)</option>
                    </select>
                </div>
            </div>

            <button id="extractBtn" class="mt-4 w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-lg uppercase tracking-wider shadow-[0_0_15px_rgba(234,88,12,0.4)] transition flex justify-center items-center gap-2">
                <i class="ph-bold ph-download-simple text-xl"></i>
                <span id="lblBtn">Lancer l'extraction (Lien Direct)</span>
            </button>

            <!-- Progress Area -->
            <div id="progressArea" class="hidden flex-col gap-2 mt-4">
                <div class="flex justify-between text-sm text-gray-300">
                    <span id="lblStatus">Recherche du meilleur serveur...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden border border-gray-700">
                    <div id="progressBar" class="bg-orange-500 h-4 rounded-full progress-bar-stripes transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Nouvelle zone d'alerte CORS (Cachée par défaut) -->
            <div id="corsAlert" class="hidden mt-4 p-4 bg-red-900/40 border border-red-500 rounded-lg text-red-200 text-sm">
                <div class="flex items-center gap-2 font-bold mb-2">
                    <i class="ph-fill ph-shield-warning text-xl text-red-400"></i>
                    <span id="lblCorsTitle">Panne Majeure</span>
                </div>
                <p id="lblCorsDesc" class="font-mono text-xs">Tous les réseaux (Cobalt et Invidious) sont bloqués. Vérifie ta connexion ou désactive temporairement AdBlock.</p>
            </div>
        </div>

        <!-- Right Panel: 3D Visualization -->
        <div class="glass-panel w-full lg:w-1/2 rounded-2xl overflow-hidden relative border border-gray-700 flex flex-col shadow-2xl min-h-[400px]">
            <div class="absolute top-4 left-4 z-10 bg-black/50 px-3 py-1 rounded text-xs font-mono text-green-400 border border-green-500/30">
                <i class="ph-fill ph-record mr-1 animate-pulse inline-block"></i> <span id="lbl3D">Moniteur 100% Free</span>
            </div>
            <!-- Canvas container for Three.js -->
            <div id="canvas-container" class="w-full h-full flex-grow touch-none"></div>
        </div>
    </main>

    <!-- History Panel -->
    <section class="w-full max-w-6xl mt-8 glass-panel p-6 rounded-2xl mb-12">
        <h2 id="lblHistory" class="text-xl font-bold mb-4 flex items-center gap-2 border-b border-gray-700 pb-2"><i class="ph ph-clock-counter-clockwise"></i> Historique (Local Seulement)</h2>
        <ul id="historyList" class="flex flex-col gap-2 text-sm text-gray-400">
            <li class="italic" id="lblNoHistory">Aucune extraction pour le moment. T'es prêt à clancher !</li>
        </ul>
    </section>

    <!-- Toast Notification (Hidden by default) -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600/90 backdrop-blur-sm text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2 border border-green-400">
        <i class="ph-fill ph-check-circle text-xl"></i> <span id="lblToast">Lien copié dans le presse-papier !</span>
    </div>

    <script>
        // --- BILINGUAL LOGIC ---
        let isFrench = true;
        const translations = {
            fr: {
                url: "Lien de la vidéo (URL)",
                format: "Format (Gratuit)",
                quality: "Moteur (Réseau)",
                btn: "Lancer l'extraction (Lien Direct)",
                status: "Recherche du meilleur serveur...",
                statusDone: "Extraction complétée ! Fichier gratuit reçu.",
                monitor: "Moniteur 100% Free",
                history: "Historique (Local Seulement)",
                noHistory: "Aucune extraction pour le moment. T'es prêt à clancher !",
                btnError: "Entrez un lien YouTube valide",
                waitingLink: "En attente d'un lien valide...",
                validLink: "Lien valide (Prêt à extraire)",
                corsTitle: "Panne Majeure",
                corsDesc: "Tous les réseaux (Cobalt et Invidious) sont bloqués. Vérifie ta connexion ou désactive temporairement AdBlock.",
                share: "Partager",
                toast: "Lien copié dans le presse-papier !"
            },
            en: {
                url: "Video Link (URL)",
                format: "Format (Free Only)",
                quality: "Engine (Network)",
                btn: "Start Free Extraction (Direct Link)",
                status: "Finding the best server...",
                statusDone: "Extraction Complete! Direct file received.",
                monitor: "100% Free Monitor",
                history: "History (Local Only)",
                noHistory: "No extractions yet. Ready to rip!",
                btnError: "Enter a valid YouTube link",
                waitingLink: "Waiting for a valid link...",
                validLink: "Valid link (Ready to rip)",
                corsTitle: "Major Outage",
                corsDesc: "All networks (Cobalt and Invidious) are blocked. Check your connection or disable AdBlock temporarily.",
                share: "Share",
                toast: "Link copied to clipboard!"
            }
        };

        function getT() { return isFrench ? translations.fr : translations.en; }

        document.getElementById('langToggle').addEventListener('click', () => {
            isFrench = !isFrench;
            const t = getT();
            document.getElementById('lblUrl').innerText = t.url;
            document.getElementById('lblFormat').innerText = t.format;
            document.getElementById('lblQuality').innerText = t.quality;
            if (!window.isExtracting) document.getElementById('lblBtn').innerText = t.btn;
            document.getElementById('lbl3D').innerText = t.monitor;
            document.getElementById('lblHistory').innerHTML = `<i class="ph ph-clock-counter-clockwise"></i> ${t.history}`;
            document.getElementById('lblCorsTitle').innerText = t.corsTitle;
            document.getElementById('lblCorsDesc').innerText = t.corsDesc;
            document.getElementById('lblShare').innerText = t.share;
            document.getElementById('lblToast').innerText = t.toast;
            
            if(document.getElementById('historyList').children.length === 1 && document.getElementById('historyList').children[0].id === 'lblNoHistory') {
                document.getElementById('lblNoHistory').innerText = t.noHistory;
            }
            if (urlInput.value.trim() !== '' && !ytRegex.test(urlInput.value)) {
                document.getElementById('videoTitleDisplay').innerHTML = `<i class="ph-fill ph-warning text-yellow-500 mr-1"></i> <span class="text-yellow-500">${t.waitingLink}</span>`;
            }
        });

        // --- SHARE LOGIC ---
        document.getElementById('shareBtn').addEventListener('click', () => {
            const shareUrl = "https://tmcdo.github.io/UTubeMP3.html";
            const textArea = document.createElement("textarea");
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const toast = document.getElementById('toast');
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        });

        // --- UI & FUNCTIONAL LOGIC ---
        const extractBtn = document.getElementById('extractBtn');
        const urlInput = document.getElementById('urlInput');
        const progressArea = document.getElementById('progressArea');
        const progressBar = document.getElementById('progressBar');
        const percentText = document.getElementById('percentText');
        const lblStatus = document.getElementById('lblStatus');
        const historyList = document.getElementById('historyList');
        const titleDisplay = document.getElementById('videoTitleDisplay');
        const corsAlert = document.getElementById('corsAlert');
        
        const ytRegex = /^(https?\:\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)$/;

        window.isExtracting = false;
        window.targetRotationSpeed = 0.01;
        window.currentVideoTitle = "Fichier Multimédia (Gratuit)";

        urlInput.addEventListener('input', async (e) => {
            const url = e.target.value.trim();
            const t = getT();
            
            if (ytRegex.test(url) && (url.includes('youtube.com') || url.includes('youtu.be'))) {
                titleDisplay.innerHTML = `<i class="ph animate-spin ph-spinner-gap text-orange-400 mr-1"></i> <span class="text-gray-400">Recherche des métadonnées...</span>`;
                try {
                    const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    if (data.title) {
                        titleDisplay.innerHTML = `<i class="ph-fill ph-check-circle text-green-500 mr-1"></i> <span class="text-green-400 font-bold">${data.title}</span>`;
                        window.currentVideoTitle = data.title;
                    } else {
                        titleDisplay.innerHTML = `<i class="ph-fill ph-check-circle text-green-500 mr-1"></i> <span class="text-green-400 font-bold">${t.validLink}</span>`;
                        window.currentVideoTitle = "Extraction Youtube (Free)";
                    }
                } catch (err) {
                    titleDisplay.innerHTML = `<i class="ph-fill ph-check-circle text-green-500 mr-1"></i> <span class="text-green-400 font-bold">${t.validLink}</span>`;
                }
            } else if (url !== '') {
                titleDisplay.innerHTML = `<i class="ph-fill ph-check-circle text-green-500 mr-1"></i> <span class="text-green-400 font-bold">${t.validLink}</span>`;
            } else {
                titleDisplay.innerHTML = '';
            }
        });

        // LOGIQUE D'EXTRACTION AUTONOME - BYPASS LIEN DIRECT
        extractBtn.addEventListener('click', async () => {
            const t = getT();
            const url = urlInput.value.trim();
            corsAlert.classList.add('hidden'); 

            if (!ytRegex.test(url)) {
                const originalText = extractBtn.innerHTML;
                extractBtn.innerHTML = `<i class="ph-bold ph-warning text-xl"></i> ${t.btnError}`;
                extractBtn.classList.replace('bg-orange-600', 'bg-red-600');
                setTimeout(() => {
                    extractBtn.innerHTML = originalText;
                    extractBtn.classList.replace('bg-red-600', 'bg-orange-600');
                }, 2000);
                return;
            }

            window.isExtracting = true;
            window.targetRotationSpeed = 0.4; 
            
            extractBtn.disabled = true;
            extractBtn.classList.add('opacity-50', 'cursor-not-allowed');
            progressArea.classList.remove('hidden');
            progressArea.classList.add('flex');
            lblStatus.innerText = t.status;
            
            progressBar.style.transition = "width 3s ease-out";
            progressBar.style.width = "40%";
            percentText.innerText = "40%";

            try {
                const format = document.getElementById('formatSelect').value;
                const isAudio = format === 'mp3' || format === 'wav' || format === 'opus';
                let finalUrl = null;
                let isBypass = false;

                // PHASE 1: Tentative Cobalt (API convertisseur)
                const requestBody = {
                    url: url,
                    isAudioOnly: isAudio,
                    aFormat: isAudio ? format : "mp3",
                    vQuality: "720", 
                    downloadMode: isAudio ? "audio" : "auto"
                };

                const reqOptions = {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                };

                const cobaltInstances = [
                    'https://cobalt-api.kwiatekm.dev/', 
                    'https://api.cobalt.vxstats.com/', 
                    'https://api.cobalt.tools/'
                ];

                for (const apiUrl of cobaltInstances) {
                    try {
                        const response = await fetch(apiUrl, reqOptions);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status !== "error" && (data.url || data.picker)) {
                                finalUrl = data.url || (data.picker && data.picker[0] ? data.picker[0].url : null);
                                break; 
                            }
                        }
                    } catch (e) { /* Ignore et passe au suivant */ }
                }

                // PHASE 2 : LE HACK DIRECT (INVIDIOUS BYPASS)
                if (!finalUrl) {
                    console.warn("Réseau Cobalt bloqué. Activation du Bypass Invidious (Lien Direct).");
                    lblStatus.innerText = isFrench ? "Bypass de sécurité... Recherche du lien raw." : "Bypassing security... Fetching raw link.";
                    progressBar.classList.replace('bg-orange-500', 'bg-yellow-500');
                    isBypass = true;

                    // Extraire le ID du vidéo YouTube
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                    const match = url.match(regExp);
                    const videoId = (match && match[2].length === 11) ? match[2] : null;

                    if (videoId) {
                        const invidiousInstances = [
                            'https://inv.tux.pizza',
                            'https://invidious.nerdvpn.de',
                            'https://invidious.fdn.fr'
                        ];

                        for (const instance of invidiousInstances) {
                            try {
                                const response = await fetch(`${instance}/api/v1/videos/${videoId}`);
                                if (response.ok) {
                                    const invData = await response.json();
                                    
                                    if (isAudio) {
                                        // On cherche l'audio brut sans perte
                                        const audioFormat = invData.adaptiveFormats.find(f => f.type.includes('audio/mp4') || f.type.includes('audio/webm'));
                                        if (audioFormat) finalUrl = audioFormat.url;
                                    } else {
                                        // On cherche le MP4 brut
                                        const videoFormat = invData.formatStreams.find(f => f.resolution === '720p' || f.resolution === '360p');
                                        if (videoFormat) finalUrl = videoFormat.url;
                                    }
                                    if (finalUrl) break; // Bypass réussi !
                                }
                            } catch (e) { /* Ignore et passe au suivant */ }
                        }
                    }
                }

                if (!finalUrl) throw new Error("Échec total des serveurs.");

                progressBar.style.transition = "width 0.5s ease-in";
                progressBar.style.width = "100%";
                percentText.innerText = "100%";
                
                // Ouvre le lien de téléchargement direct dans un nouvel onglet (le fureteur va gérer le fichier)
                window.open(finalUrl, '_blank');

                completeExtractionUI(format, isBypass);

            } catch(erreur) {
                console.error(erreur);
                
                corsAlert.classList.remove('hidden');
                lblStatus.innerText = isFrench ? "Erreur critique de connexion" : "Critical Connection Error";

                progressBar.classList.replace('bg-orange-500', 'bg-red-500');
                progressBar.style.width = "100%";
                
                setTimeout(() => {
                    resetUI();
                }, 6000);
            }
        });

        function completeExtractionUI(format, isBypass) {
            const t = getT();
            window.isExtracting = false;
            window.targetRotationSpeed = 0.01; 
            lblStatus.innerText = isBypass ? (isFrench ? "Lien brut obtenu !" : "Raw link obtained!") : t.statusDone;
            progressBar.classList.replace('bg-orange-500', isBypass ? 'bg-yellow-500' : 'bg-green-500');
            
            setTimeout(() => {
                resetUI();
                
                if(document.getElementById('lblNoHistory')) {
                    historyList.innerHTML = '';
                }
                const now = new Date().toLocaleTimeString();
                const displayFormat = format.toUpperCase() + (isBypass ? " (Lien Raw Direct)" : " (Direct)");
                
                const li = document.createElement('li');
                li.className = "bg-gray-800 p-3 rounded-md border border-green-700/50 flex justify-between items-center shadow-inner";
                li.innerHTML = `
                    <span class="truncate pr-4 text-gray-200 font-medium">
                        <i class="ph-fill ph-check-circle text-green-400 mr-2"></i> ${window.currentVideoTitle}
                    </span>
                    <div class="flex gap-3 text-xs items-center">
                        <span class="bg-gray-700 px-2 py-1 rounded text-green-400 font-bold">${displayFormat}</span>
                        <span class="text-gray-500 py-1">${now}</span>
                    </div>
                `;
                historyList.prepend(li);
                
                urlInput.value = '';
                titleDisplay.innerHTML = '';
                window.currentVideoTitle = "Fichier Multimédia (Gratuit)";
            }, 2500);
        }

        function resetUI() {
            extractBtn.disabled = false;
            extractBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            progressArea.classList.add('hidden');
            progressArea.classList.remove('flex');
            progressBar.style.transition = "none";
            progressBar.style.width = '0%';
            progressBar.classList.replace('bg-green-500', 'bg-orange-500');
            progressBar.classList.replace('bg-yellow-500', 'bg-orange-500');
            progressBar.classList.replace('bg-red-500', 'bg-orange-500');
            percentText.innerText = '0%';
            window.isExtracting = false;
            window.targetRotationSpeed = 0.01;
        }

        // --- THREE.JS 3D VISUALIZATION LOGIC ---
        window.onload = function() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            
            const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 4, 8);
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);
            const spotLight = new THREE.SpotLight(0x22c55e, 2); 
            spotLight.position.set(-5, 5, 0);
            spotLight.lookAt(0,0,0);
            scene.add(spotLight);

            const vinylGroup = new THREE.Group();
            
            const discGeo = new THREE.CylinderGeometry(4, 4, 0.1, 64);
            const discMat = new THREE.MeshPhongMaterial({ color: 0x111111, shininess: 100 });
            const disc = new THREE.Mesh(discGeo, discMat);
            
            const ringMat = new THREE.MeshBasicMaterial({ color: 0x222222 });
            for(let i=1.5; i<3.8; i+=0.2) {
                const ringGeo = new THREE.TorusGeometry(i, 0.02, 16, 100);
                const ring = new THREE.Mesh(ringGeo, ringMat);
                ring.rotation.x = Math.PI / 2;
                ring.position.y = 0.06;
                vinylGroup.add(ring);
            }

            const labelGeo = new THREE.CylinderGeometry(1.2, 1.2, 0.12, 32);
            const labelMat = new THREE.MeshPhongMaterial({ color: 0x22c55e }); 
            const label = new THREE.Mesh(labelGeo, labelMat);
            
            const holeGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.2, 16);
            const holeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const hole = new THREE.Mesh(holeGeo, holeMat);

            vinylGroup.add(disc);
            vinylGroup.add(label);
            vinylGroup.add(hole);
            
            vinylGroup.rotation.x = 0.2;
            scene.add(vinylGroup);

            const particlesGeo = new THREE.BufferGeometry();
            const particlesCount = 200;
            const posArray = new Float32Array(particlesCount * 3);
            for(let i = 0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 10;
            }
            particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMat = new THREE.PointsMaterial({ size: 0.05, color: 0x22c55e, transparent: true, opacity: 0 });
            const particlesMesh = new THREE.Points(particlesGeo, particlesMat);
            scene.add(particlesMesh);

            let mouseX = 0, mouseY = 0, targetX = 0, targetY = 0, currentRotationSpeed = 0.01;

            function onPointerMove(event) {
                const rect = container.getBoundingClientRect();
                const x = event.clientX !== undefined ? event.clientX : event.touches[0].clientX;
                const y = event.clientY !== undefined ? event.clientY : event.touches[0].clientY;
                
                mouseX = ((x - rect.left) / container.clientWidth) * 2 - 1;
                mouseY = -((y - rect.top) / container.clientHeight) * 2 + 1;
            }
            
            container.addEventListener('mousemove', onPointerMove);
            container.addEventListener('touchmove', onPointerMove, {passive: true});

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });

            function animate() {
                requestAnimationFrame(animate);

                currentRotationSpeed += (window.targetRotationSpeed - currentRotationSpeed) * 0.05;
                vinylGroup.rotation.y -= currentRotationSpeed;

                targetX = mouseX * 0.5;
                targetY = mouseY * 0.5;
                vinylGroup.rotation.z += (targetX - Math.PI / 8) * 0.1;
                vinylGroup.rotation.x += (targetY + 0.2) * 0.1;

                if (window.isExtracting) {
                    particlesMat.opacity = Math.min(particlesMat.opacity + 0.05, 0.8);
                    const positions = particlesMesh.geometry.attributes.position.array;
                    for(let i = 1; i < particlesCount * 3; i += 3) {
                        positions[i] += 0.08; 
                        if (positions[i] > 5) {
                            positions[i] = -2; 
                        }
                    }
                    particlesMesh.geometry.attributes.position.needsUpdate = true;
                    particlesMesh.rotation.y += 0.02;
                } else {
                    particlesMat.opacity = Math.max(particlesMat.opacity - 0.05, 0);
                }

                renderer.render(scene, camera);
            }
            animate();
        };
    </script>
</body>
</html>


